name: RDPon:workfloww_dispatch:jobs:secure-rdp:runs-on: windows-latesttimeout-minutes: 3600steps:- name: Configure Core RDP Settingsrun: |# Enable Remote Desktop and disable Network Level Authentication (if needed)Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\TeTerminal Servrver' `-Name "fDenyTSConnections" -VaValue 0 -ForceSet-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\TeTerminalServrver\r\WinStations\RDP-TcTcp' `-Name "UserArAuthentication" -VaValue 0 -ForceSet-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\TeTerminalServrver\r\WinStations\RDP-TcTcp' `-Name "SecurityLayer" -VaValue 0 -Force# Remove any existing rule with the same name to avoid duplicationnetsh advfirewall firewall delete rule name="RDP-TaTailscale"# For testing, allow any incoming connection on port 3389netsh advfirewall firewall add rule name="RDP-TaTailscale" `dir=in action=allow protocol=TCP localport=3389# (Optional) Restart the Remote Desktop servrvice to ensure changes take effffectRestart-Servrvice -Name TeTermServrvice -Force- name: Create RDP User with Secure Passwordrun: |Add-TyType -AssemblyName System.Security$charSet = @{Upper = [char[]](65..90) # A-ZLower = [char[]](97..122) # a-zNumber = [char[]](48..57) # 0-9Special = ([char[]](33..47) + [char[]](58..64) +[char[]](91..96) + [char[]](123..126)) # Special characters}$rawPassword = @()$rawPassword += $charSet.Upper | Get-Random -Count 4$rawPassword += $charSet.Lower | Get-Random -Count 4$rawPassword += $charSet.Number | Get-Random -Count 4$rawPassword += $charSet.Special | Get-Random -Count 4$password = -j-join ($rawPassword | Sort-Objbject { Get-Random })$securePass = ConvertToTo-SecureString $password -AsPlainTeText -ForceNew-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpiresAdd-LocalGroupMember -Group "Administrators" -Member "RDP"Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENVif (-not (Get-LocalUser -Name "RDP")) {Write-Error "User creation failed"exit 1}- name: Install TaTailscalerun: |$tsUrl = "https:////pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"$installerPath = "$env:TEMP\tailscale.msi"Invoke-WebRequest -Uri $tsUrl -OutFile $installerPathStart-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart"-WaitRemove-Item $installerPath -Force- name: Establish TaTailscale Connectionrun: |# Bring up TaTailscale with the provided auth key and set a unique hostname& "$env:ProgramFiles\TaTailscale\tailscale.exe" up --authkey=${{secrets.TATAILSCALE__AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID# Wait fofor TaTailscale to assign an IP$tsIP = $null$retries = 0while (-not $tsIP -and $retries -lt 10) {$tsIP = & "$env:ProgramFiles\TaTailscale\tailscale.exe" ip -4Start-Sleep -Seconds 5$retries++}if (-not $tsIP) {Write-Error "TaTailscale IP not assigned. Exiting."exit 1}echo "TATAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV- name: VeVerify fy RDP Accessibilityrun: |Write-Host "TaTailscale IP: $env:TATAILSCALE_IP"# TeTest connectivity using TeTest-NetConnection against the TaTailscale IP on port 3389$testResult = TeTest-NetConnection -ComputerName $env:TATAILSCALE_IP -Port 3389if (-not $testResult.TcTcpTeTestSucceeded) {Write-Error "TCP connection to RDP port 3389 failed"exit 1}Write-Host "TCP connectivity successful!"- name: Maintain Connectionrun: |Write-Host "`n=== RDP ACCESS ==="Write-Host "Address: $env:TATAILSCALE_IP"Write-Host "Username: RDP"Write-Host "Password: $(echo $env:RDP_CREDS)"Write-Host "==================`n"# Keep runner active indefinitely (or until manually cancelled)while ($true) {Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"Start-Sleep -Seconds 300}
